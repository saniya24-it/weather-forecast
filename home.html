<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Weather Forecasting & Advisory System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0b1220;
  color: #fff;
}

/* HEADER */
header {
  background: #1e3a8a;
  padding: 14px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h2 {
  margin: 0;
  font-size: 20px;
}

/* SEARCH */
.search-container {
  padding: 15px;
  background: #020617;
  display: flex;
  gap: 10px;
}

.search-container input {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: none;
}

.search-container button {
  padding: 10px 18px;
  border-radius: 8px;
  border: none;
  background: #2563eb;
  color: white;
  cursor: pointer;
}

/* MAP */
#map {
  height: 100vh;
}

/* WEATHER CARD */
.weather-card {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: #020617;
  padding: 18px;
  border-radius: 16px;
  width: 260px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  opacity: 0;
  transform: translateY(30px);
  transition: all 0.6s ease;
}

.weather-card.show {
  opacity: 1;
  transform: translateY(0);
}

.weather-card h3 {
  margin: 0 0 8px;
}

.weather-card p {
  margin: 4px 0;
  font-size: 14px;
  opacity: 0.9;
}.weather-card {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: rgba(15, 23, 42, 0.95);
  color: #fff;
  padding: 16px 20px;
  border-radius: 14px;
  width: 220px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  opacity: 0;
  transform: translateY(30px);
  transition: all 0.4s ease;
  z-index: 999;
}

.weather-card.show {
  opacity: 1;
  transform: translateY(0);
}

.weather-card h3 {
  font-size: 18px;
  margin-bottom: 6px;
}

.weather-card p {
  margin: 4px 0;
  font-size: 14px;
}
/* ================= MOBILE RESPONSIVE ================= */
@media (max-width: 1024px) {
  .content {
    grid-template-columns: 1fr;
  }
}

/* Tablets & Phones */
@media (max-width: 768px) {

  body {
    overflow-x: hidden;
  }

  /* DASHBOARD */
  .dashboard {
    flex-direction: column;
  }

  /* SIDEBAR → TOP BAR */
  .sidebar {
    width: 100%;
    height: 60px;
    flex-direction: row;
    justify-content: space-around;
    padding: 10px;
  }

  .sidebar a {
    font-size: 20px;
  }

  /* MAIN */
  .main {
    padding: 14px;
  }

  /* TOP BAR */
  .topbar {
    flex-direction: column;
    gap: 12px;
  }

  .search-box {
    width: 100%;
  }

  .search-box input {
    width: 100%;
  }

  /* CARDS */
  .card {
    padding: 16px;
    border-radius: 16px;
  }

  .temp {
    font-size: 42px;
  }

  /* TODAY / WEEK */
  .today-week {
    flex-direction: column;
  }

  .hourly {
    overflow-x: auto;
  }

  /* OTHER CITIES */
  .cities-grid {
    grid-template-columns: 1fr;
  }

  /* MAP */
  #indiaMap {
    height: 320px !important;
  }

  /* NEWS */
  .news-grid {
    grid-template-columns: 1fr;
  }

  /* FORMS */
  input, textarea, button {
    font-size: 16px;
  }
}

/* Small Phones */
@media (max-width: 480px) {

  h1, h2, h3 {
    font-size: 18px;
  }

  .temp {
    font-size: 36px;
  }

  .sidebar a {
    font-size: 18px;
  }

  .hour-card {
    width: 60px;
    font-size: 12px;
  }

  .alert-box {
    width: 90%;
  }
}

</style>
</head>

<body>

<header>
  <h2>SMART WEATHER FORECASTING & ADVISORY SYSTEM</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="search-container">
  <input list="indiaLocations" id="cityInput" placeholder="Type city or state (e.g. Mumbai, Karnataka)">
  <datalist id="indiaLocations"></datalist>
  <button onclick="getWeather()">Search</button>
</div>

<div id="map"></div>

<!-- Weather Card -->
<div class="weather-card" id="weatherCard">
  <h3 id="place">--</h3>
  <p id="temp">-- °C</p>
  <p id="condition">--</p>
</div>

<script>
/* ================= LOGIN CHECK ================= */
if (localStorage.getItem("loggedIn") !== "true") {
  window.location.href = "login.html";
}

function logout() {
  localStorage.removeItem("loggedIn");
  window.location.href = "login.html";
}

/* ================= API ================= */
const API_KEY = "9a7b56b6f5b919658a75bca363637638";

/* ================= INDIA DATA ================= */
const indiaData = {
  "Maharashtra": ["Mumbai","Pune","Nagpur","Nashik","Aurangabad"],
  "Karnataka": ["Bengaluru","Mysuru","Hubballi"],
  "Tamil Nadu": ["Chennai","Coimbatore","Madurai"],
  "Kerala": ["Kochi","Thiruvananthapuram"],
  "Telangana": ["Hyderabad","Warangal"],
  "Uttar Pradesh": ["Lucknow","Kanpur","Varanasi"],
  "Delhi": ["New Delhi"],
  "Gujarat": ["Ahmedabad","Surat","Vadodara"],
  "West Bengal": ["Kolkata","Howrah"]
};

const datalist = document.getElementById("indiaLocations");
Object.keys(indiaData).forEach(state => {
  datalist.innerHTML += `<option value="${state}">`;
  indiaData[state].forEach(city => {
    datalist.innerHTML += `<option value="${city}">`;
  });
});

/* ================= MAP ================= */
const map = L.map("map", {
  center: [22.5937, 78.9629],
  zoom: 5,
  minZoom: 4,
  maxZoom: 7,
  maxBounds: [[6.5, 68],[37.5, 97]]
});

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

let marker;

/* ================= WEATHER ================= */
async function getWeather() {
  document.getElementById("temp")

  const city = document.getElementById("cityInput").value.trim();
  if (!city) return;

  try {
    const res = await fetch(
      `https://api.openweathermap.org/data/2.5/weather?q=${city},IN&units=metric&appid=${API_KEY}`
    );
    const data = await res.json();

    if (data.cod !== 200) return;

    // Update card
document.getElementById("place").innerText = data.name;
document.getElementById("temp").innerText =
  Math.round(data.main.temp) + " °C";
document.getElementById("condition").innerText =
  data.weather[0].description;

/* Animate card */
const card = document.getElementById("weatherCard");
card.classList.remove("show");
setTimeout(() => card.classList.add("show"), 50);


  

    // Map marker
    if (marker) map.removeLayer(marker);
    marker = L.marker([data.coord.lat, data.coord.lon])
      .addTo(map)
      .bindPopup(data.name)
      .openPopup();

    map.setView([data.coord.lat, data.coord.lon], 6);

    saveWeatherData(
  data.name,
  Math.round(data.main.temp),
  data.weather[0].description
);


  } catch (err) {
    console.error(err);
  }
}
const params = new URLSearchParams(window.location.search);
const alertMsg = params.get("alert");

if (alertMsg) {
  alert("Active Alert: " + alertMsg);
}

async function saveWeather(email, city, temp, desc) {
  try {
    await fetch("http://127.0.0.1:5000/api/save-weather", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email,
        city,
        temperature: temp,
        description: desc
      })
    });
  } catch (e) {
    console.error("Weather save failed", e);
  }
}

</script>

</body>
</html>
